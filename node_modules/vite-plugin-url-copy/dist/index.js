import{colorize as l}from"consola/utils";import h,{consola as v}from"consola";import{renderUnicodeCompact as U}from"uqr";const C="vite-plugin-url-copy",O="1.1.4",f=console.log;function x(o){return Object.prototype.toString.call(o)==="[object Object]"}function p(o=0){return new Promise(e=>{setTimeout(()=>{e()},o)})}async function g(o){try{return await o()}catch(e){return Promise.reject(e)}}let P={};function k(o){let e=!1;function t(r,s){for(const i of Object.keys(r))if(x(r[i])){const c=t(r[i],s[i]);if(c)return c}else if(r[i]!==s[i])return e=!0,e;return e}return t(o,P),e&&(P=o),e}const L=10;let w=0;async function $(o){const e=o.resolvedUrls;if(w>=L)throw new Error("timeout");return e?(w=0,e):(w++,await p(),$(o))}const y=[];function j(...o){y.push(...o)}const B=l("blue"," vite-plugin-url-copy_debug ");function q(o){if(!o)return;const e=y.length;let t="";for(const[r,s]of y.entries())t+=l("blue",s),r!==e-1&&(t+=`

`);f(`
`),h.box({title:B,message:t,style:{padding:1,borderColor:"gray",borderStyle:"rounded"}}),y.length=0}const R=(o,e)=>{const{custom:t,mode:r,disabled:s,color:i}=e.copy,c=e.debug;if(!s)return g(async()=>{let n="",u=!1;typeof t=="string"&&t&&(u=!0,n=t),typeof t=="function"&&(u=!0,n=t(o[r][0])),n||(n=o[r][0]);const a=u?"cutsom":r;if(c&&j(`copy: ${a} - ${n}`,`copy: ${JSON.stringify(e.copy)}`),!n){await p(),v.warn(`url-copy: ${r} mode URL is undefined, Please check your vite configuration.`);return}return await(await import("clipboardy")).default.write(n),f(l("green",`
  \u2714 `),l(i,`\xB7${a}\xB7 already copied to clipboard - ${n} `)),n}).catch(n=>{v.warn(`url-copy: ${n}`)})},b="network",S=(o,e)=>{const{custom:t,disabled:r,color:s}=e.qrcode,i=e.debug;if(r)return;let c="",n=!1;if(typeof t=="string"&&t&&(n=!0,c=t),typeof t=="function"&&(n=!0,c=t(o[b][0])),c||(c=o[b][0]),i&&j(`qrcode: ${n?"cutsom":b} - ${c}`,`qrcode: ${JSON.stringify(e.copy)}`),!c){h.warn("url-copy: QR-Code uses a network URL, Please check your vite configuration.");return}const u=Q(c);let a="";try{a=[...u].map((d,m)=>(m||(d=`	${d}`),d===`
`&&(d=`${d}	`),d)).join("")}catch{a=u}f(l("green",`
  \u2714 `),l(s,`\xB7QRCode\xB7 of the ${b} - ${c} `),`
`),f(l(s,a))};function Q(o){return U(o,{ecc:"L",border:1})}const N={copy:{disabled:!1,mode:"local",custom:"",color:"green"},qrcode:{disabled:!0,custom:"",color:"green"},disabled:!1,debug:!1};function A(o){const{disabled:e,copy:t={},qrcode:r={},debug:s}=o,{disabled:i,copy:c,qrcode:n,debug:u}=N;return{copy:{...c,...t},qrcode:{...n,...r},disabled:e??i,debug:s??u}}function E(o={}){const e=A(o);return{name:"server-url-copy",configureServer(t){if(e.disabled)return;const r=t.listen,s=t;s.listen=function(...i){const[c,n]=i;return g(async()=>{const u=await r.apply(this,i),a=await $(u);return g(async()=>{const d=u.config.server.port,m=k({port:d,...e});n&&!m||(await p(),f(l("green",`
 \u26A1${C.toLocaleUpperCase()} v${O}`)),await R(a,e),S(a,e),q(e.debug))}),u})}},configurePreviewServer(t){e.disabled||t.httpServer.once("listening",()=>{g(async()=>{await p(),f(l("green",`
 \u26A1${C.toLocaleUpperCase()} v${O}`));const r=await $(t);await R(r,e),S(r,e),q(e.debug)})})}}}export{E as default};
